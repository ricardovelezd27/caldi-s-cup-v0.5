
# Fix: Broken Multi-Image Display on Coffee Profile

## Root Cause

The `coffee-scans` storage bucket is **private**, but the code in `uploadScanImages.ts` (and `useManualAddCoffee.ts`) uses `getPublicUrl()` to generate image URLs. Public URLs don't work on private buckets, so all stored image links return errors -- which is why the main image and thumbnails show broken/alt-text placeholders.

This only affects multi-image scans because single-image scans use a signed URL generated by the backend edge function (which works fine with private buckets).

## Fix Strategy

Make the `coffee-scans` bucket public. These images are non-sensitive photos of coffee bags, so there is no security risk. The original bucket creation had it as public; it was later made private by a security scan that flagged it generically.

## Changes

### 1. Database Migration -- Make bucket public again
A single SQL migration:
- `UPDATE storage.buckets SET public = true WHERE id = 'coffee-scans';`
- Re-add a public SELECT policy so anyone can view coffee scan images
- Drop the restrictive "Users can view own coffee scans" SELECT policy

### 2. No code changes needed
Once the bucket is public, the existing `getPublicUrl()` calls in `uploadScanImages.ts` and `useManualAddCoffee.ts` will work correctly. The URLs already stored in the `additional_image_urls` column will immediately start loading.

## What This Fixes
- Main image display on coffee profile for multi-image scans
- Thumbnail gallery display (Amazon-style layout)
- Both fresh scans and revisits from profile/dashboard/favorites
- Works across mobile, tablet, and desktop

## Security Note
The upload policy remains restricted to authenticated users uploading to their own folder. Only the read (SELECT) access becomes public, which is appropriate for coffee bag photos.
